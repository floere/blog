<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-type" />
    <link href="../../../favico.ico" rel="shortcut icon" />
    <!-- Ugh. -->
    <script src="../../../javascripts/shjs-0.6/sh_main.min.js" type="text/javascript"></script>
    <link href="../../../javascripts/shjs-0.6/css/sh_nedit.min.css" rel="stylesheet" type="text/css" />
    <link href="../../../stylesheets/basic.css" rel="stylesheet" type="text/css" />
    <link href="../../../stylesheets/specific.css" rel="stylesheet" type="text/css" />
    <title>Picky&nbsp;Active&nbsp;Record</title>
    <script type="text/javascript">
      //<![CDATA[
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-20991642-1']);
        _gaq.push(['_trackPageview']);
        
        (function() {
          var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
      //]]>
    </script>
  </head>
  <body onload='sh_highlightDocument("../../../javascripts/shjs-0.6/lang/", ".min.js");'>
    <ol class="nav">
      <li>
        <a href="./../../../../">home</a>
        •
      </li>
      <li>
        <a href="./../../../">blog</a>
        •
      </li>
      <li>
        <a href="./../../../../picky/">picky</a>
        •
      </li>
      <li>
        <a href="./../../../../phd/">phd</a>
        •
      </li>
      <li>
        <a href="./../../../../phony/">phony</a>
        •
      </li>
      <li>
        <a href="./../../../../view_models/">view models</a>
      </li>
    </ol>
    <div class="post">
      <h1>Picky&nbsp;Active&nbsp;Record</h1>
      <div class="categories">
        ruby / picky
      </div>
      <!-- /  - page.categories.each do |category| -->
      <!-- /    %a{ :href => "/blog/category/#{category}" }= category -->
      <p>This post is about the challenges of designing an Active Record interface for Picky.</p>
      <p>When we last time looked at writing a nice ActiveRecord integration, around version 2.0, and then 3.0, Picky the server wasn&#8217;t ready yet.</p>
      <p>What was missing?</p>
      <p>Most importantly, an interface to save updates as they come in (in Picky: <code>Index#add</code>, <code>Index#remove</code>, <code>Index#replace</code>). Secondly, the possibility to dump indexes during runtime (<code>Index#dump</code>).</p>
      <p>How would we go about designing an Active Record interface for Picky? How do others do it?</p>
      <h2>Others</h2>
      <p>Some search servers (like <a href="http://sphinxsearch.com/">Sphinx</a>) do not really offer an interface for live updates, but instead go the route of cleverly reindexing from a central data repository.</p>
      <p>Other search servers offer <span class="caps">HTTP</span> interfaces (for example <a href="http://elasticsearch.org">elasticsearch</a> with its <span class="caps">JSON</span> <span class="caps">POST</span>/<span class="caps">PUT</span> etc. interface).</p>
      <p>Since it is a nice and flexible standard interface, it enables interested coders to write software for it, for example <a href="http://github.com/karmi/tire">Tire</a>. This is a great way of attracting effort.</p>
      <p>Another idea would be to open a port the engine listens on, pipes, or any form of communication imaginable.</p>
      <p>In any case, Picky needs a standard interface.</p>
      <h2>The rough idea</h2>
      <p>Our rough idea is to listen for updates in the server and create a gem for use with active record (and others), which talks to the server every time some data is updated.</p>
      <p>What are the challenges in the server?</p>
      <h2>The Server</h2>
      <p>Picky does not have a standard external interface beyond the <code>Picky::Index</code> and <code>Picky::Search</code>, which searches over the indexes.</p>
      <pre class="sh_ruby"><code>index = Picky::Index.new(:name) do&#x000A;  # ...&#x000A;end&#x000A;things = Picky::Search.new index&#x000A;things.search 'something'</code></pre>
      <p>Of course, this is a very flexible approach, but comes with the problem that we need an implementation for all the different containers of Picky.</p>
      <p>In the case of Sinatra, it will offer a <span class="caps">HTTP</span> interface, where the picky-activerecord gem will send updates to.</p>
      <p>Let&#8217;s see how we would implement that. For updates, we will define a put action:</p>
      <pre class="sh_ruby"><code>put '/' do&#x000A;  index_name = params['index']&#x000A;  index = Picky::Indexes[index_name.to_sym] # Get the right index from the indexes.&#x000A;  index.replace_from params['data']&#x000A;end</code></pre>
      <p>The method <code>replace_from(hash)</code> is available in edge currently. Error handling is omitted.</p>
      <p>Then we can write up the <span class="caps">DELETE</span> action etc., wrap it into a nice module <code>Picky::Interfaces::External</code>, for example.</p>
      <p>Finally, if someone wants their indexes updated by anything external, she would extend the Sinatra app with that <code>Module</code>:</p>
      <pre class="sh_ruby"><code>class MyPickyServer &lt; Sinatra::Base&#x000A;  extend Picky::Interfaces::External&#x000A;  &#x000A;  # ...&#x000A;end</code></pre>
      <p>Then, when we&#8217;d like to create/update/delete an indexed entry, we simply send a <span class="caps">HTTP</span> request to the Picky server with the following payload:</p>
      <pre><code>{&#x000A;  index: "people",&#x000A;  data: {&#x000A;    id: 7,&#x000A;    name: "Florian",&#x000A;    surname: "Hanke"&#x000A;  }&#x000A;}</code></pre>
      <p>Sounds easy so far, right?</p>
      <p>Ah, but what if we stop and restart Picky? What happens to the indexed data?</p>
      <h3>When Picky is restarted</h3>
      <p>Let&#8217;s say you don&#8217;t use the realtime <code>SQLite</code> or <code>Redis</code> persistent backend to store your indexes, but the standard <code>Memory</code> backend.</p>
      <p>If we simply restarted, we would lose the indexes. We need a way to dump the data. One way to do this is simply dumping it when you quit Picky:</p>
      <pre class="sh_ruby"><code>at_exit { Picky::Indexes.dump }</code></pre>
      <p>or a specific index:</p>
      <pre class="sh_ruby"><code>at_exit { the_index.dump }</code></pre>
      <p>And then, as you restart the server, you simply load the indexes. Probably in <code>config.ru</code>:</p>
      <pre class="sh_ruby"><code>Picky::Indexes.load</code></pre>
      <p>I&#8217;m quite excited about this!</p>
      <p>Sure, you have to write this yourself, but … you also <strong><span class="caps">CAN</span></strong> write it yourself. And control the behaviour of it. Dump it every X requests? Only on exit? I don&#8217;t care! (I mean, I <strong>do</strong>, but not how you do it :) )</p>
      <p>In closing, I like that in a documentation, picky-activerecord will only need a single line for the server: Add <code>extend Picky::Interfaces::External</code> to your Sinatra app.</p>
      <h3>Other interfaces?</h3>
      <p>At the beginning, we will focus on writing an experimental/standard Sinatra interface.</p>
      <p>This will result in a nice Module that people can use to make their Sinatra Picky server open to external updates.</p>
      <p>But what about other interfaces?</p>
      <p>Since we expect the Picky Sinatra external interface to only be around 20-30 lines, we&#8217;ll just leave it open for now and implement as the need arises.</p>
      <h2>The Client</h2>
      <p>We&#8217;ll save the discussion on the client for later, but just quickly outline the ideas:</p>
      <ol>
      	<li>It should offer a simple and easy configuration possibility, with the default being <code>host: 'localhost', port: 8080, path:'/'</code>.</li>
      	<li>It hooks into the <code>after_save</code> callback.</li>
      	<li>It offers the possibility to save arbitrary data (not just model <code>Person</code>, or <code>Company</code> etc., but arbitrary hashes, like <code>Music</code>, including a list of <code>Genres</code>, even though that combined object doesn&#8217;t exist – I might note that it could make great sense to create a combined model like this).</li>
      	<li>It should be less than 100 lines. I&#8217;m not kidding.</li>
      </ol>
      <h2>You</h2>
      <p>What do you think of the server design? Any obvious flaws? Ideas? Suggestions by those who have used other, similar interfaces?</p>
      <p>Have you already started on writing a picky-activerecord gem? :D</p>
      <p>In any case, thanks for following the slow but steady progress of Picky!</p>
      Next
      <a href="/blog/2012/01/13/picky-active-record-2.html" title="Next post: Picky&amp;nbsp;Active&amp;nbsp;Record&amp;nbsp;2">Picky&nbsp;Active&nbsp;Record&nbsp;2</a>
      <br />
      Previous
      <a class="previous" href="../../../2011/12/29/picky-recipes-1.html" title="Previous post: Picky&amp;nbsp;Recipes">Picky&nbsp;Recipes</a>
      <h2>Comments?</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        //<![CDATA[
          var disqus_shortname = 'florianhanke';
          var disqus_developer = location.host.match(/\.dev$|^localhost/) ? 1 : 0;
          var disqus_identifier = '/2012/01/04/picky-active-record';
          var disqus_url = 'http://florianhanke.com/blog/2012/01/04/picky-active-record.html';
          
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        //]]>
      </script>
      <noscript>
        Please enable JavaScript to view the
        <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
      </noscript>
    </div>
  </body>
</html>
